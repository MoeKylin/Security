- [第一章 网络基础知识](#第一章-网络基础知识)
  - [1.3 协议](#13-协议)
  - [1.5 协议分层与OSI参考模型](#15-协议分层与osi参考模型)
  - [1.7 传输方式的分类](#17-传输方式的分类)
  - [1.8 地址](#18-地址)
  - [1.9 网络的构成要素](#19-网络的构成要素)
  - [1.10 现代网络时态](#110-现代网络时态)
- [第二章 TCP/IP 基础知识](#第二章-tcpip-基础知识)
  - [2.4 TCP/IP 基础模型](#24-tcpip-基础模型)
  - [2.5 TCP/IP 分层模型通信实例](#25-tcpip-分层模型通信实例)
- [第三章 数据链路](#第三章-数据链路)
  - [3.1 数据链路的作用](#31-数据链路的作用)
  - [3.2 数据链路相关技术](#32-数据链路相关技术)
  - [3.3 PPP](#33-ppp)
- [第四章 IP 协议](#第四章-ip-协议)
  - [4.1 IP 即网络协议](#41-ip-即网络协议)
  - [4.2 IP 基础知识](#42-ip-基础知识)
  - [4.3 IP 地址基础知识](#43-ip-地址基础知识)
  - [4.4 路由控制](#44-路由控制)
  - [4.6 IPv6](#46-ipv6)
- [第五章 IP 协议相关技术](#第五章-ip-协议相关技术)
  - [5.2 DNS](#52-dns)
  - [5.3 ARP](#53-arp)
  - [5.4 ICMP](#54-icmp)
  - [5.5 DHCP](#55-dhcp)
  - [5.6 NAT](#56-nat)
  - [5.7 IP 隧道](#57-ip-隧道)
- [第六章 TCP与UDP](#第六章-tcp与udp)
  - [6.1 传输层的作用](#61-传输层的作用)
  - [6.2 端口号](#62-端口号)
  - [6.3 UDP](#63-udp)
  - [6.4 TCP](#64-tcp)
  - [6.6 UDP 首部的格式](#66-udp-首部的格式)
  - [6.7 TCP 首部格式](#67-tcp-首部格式)
- [第七章 路由协议](#第七章-路由协议)
  - [7.1 路由控制的定义](#71-路由控制的定义)
  - [7.4 RIP](#74-rip)
  - [7.5 OSPF](#75-ospf)
  - [7.6 BGP](#76-bgp)
- [第八章 应用协议](#第八章-应用协议)
  - [8.1 应用层协议概要](#81-应用层协议概要)
  - [8.2 远程登录](#82-远程登录)
  - [8.3 文件传输](#83-文件传输)
  - [8.4 电子邮件](#84-电子邮件)
  - [8.5 WWW](#85-www)
  - [8.6 网络管理](#86-网络管理)
- [第九章 网络安全](#第九章-网络安全)
  - [9.1 TCP/IP 与网络安全](#91-tcpip-与网络安全)
  - [9.2 网络安全构成要素](#92-网络安全构成要素)
  - [9.3 加密技术基础](#93-加密技术基础)
  - [9.4 安全协议](#94-安全协议)

- **相关资源**
  - 书籍资源: [Information_Security_Books/073图解TCP_IP_第5版](https://github.com/olist213/Information_Security_Books/tree/main/073%E5%9B%BE%E8%A7%A3TCP_IP_%E7%AC%AC5%E7%89%88)
  - 精简版1: [五万字，快速读完《图解TCP/IP》核心内容](https://blog.csdn.net/qq_59392324/article/details/120698235)
  - 精简版2: [网络另一篇干货《图解TCP/IP》-封顶大吉【值得收藏】 - 掘金](https://juejin.cn/post/6928280495310503944)

## 第一章 网络基础知识

### 1.3 协议

在计算机网络与信息通信领域里，人们经常提及“协议”一词。**互联网常用的具有代表性的协议有IP,TCP,HTTP等**。

“计算机网络体系结构”将这些网络协议进行了系统的归纳。TCP/IP就是IP,TCP,HTTP等协议的集合。可用于互联网和局域网。

简单来说，**协议就是计算机与计算机之间通过网络实现通信时实现达成的一种“约定”**。这种“约定”使那些由不同厂商的设备，不同的CPU以及不同的操作系统组成的计算机之间，只要遵循相同的协议就能够实现通信。

**分组交换**是指将大数据分割为一个个的叫包（Packet）的较小单位进行传输的方法。这里所说的包，如同我们平常在邮局里见到的邮包。分组交换就是将大数据分装为一个个这样的邮包交给对方。

### 1.5 协议分层与OSI参考模型

**OSI模型将通讯协议中必要的协议分为7层**。通过这些分层，使得那些复杂的网络协议更加简单化。

在分层中，**每个分层都接收由它下一层所提供的特定服务，并且负责为自己的上一次提供特定的服务**。上下层之间进行交互时所遵循的约定叫做“**接口**”，同一层之间的交互所遵循的约定叫做“**协议**”。

**各个分层的作用** 

- **应用层**：**为应用程序提供服务**并**规定**应用层程序中**通信**相关的**细节**。包括文件传输，电子邮件，远程登录(虚拟终端)等协议。
- **表示层**：**将应用处理的信息转换为**适合**网络传输的格式**, 或将来自下一层的数据转按为上层能够处理的格式。因此它主要**负责数据格式的转换**。
	具体来说,就是将设备固有的数据格式转换为网络标准传输格式。不同设备对同一比特流解释的结果可能会不同。因此,使它们保持一致是这一层的主要作用。
- **会话层**：负责**建立和断开通信连接**(数据流动的運辑通路),以及**数据的分割**等数据**传输**相关的**管理**。
- **传输层**：起着**可靠传输**的作用。只在**通信双方节点上进行处理**,而无需在路由器上处理。
- **网络层**：将数据传输到目标地址。目标地址可以是多个网络通过路由器连接而成的某一个地址。因此这一层主要负责寻址和路由选择。
- **数据链路层**：负责**物理层**面上**互连**的、**节点之间**的**通信传输**。例如与1个以太网相连的2个节点之间的通信。将0、1序列划分为具有意义的数据桢传送给对端(数捆桢的生成与接收)。
- **物理层**：负责0、1**比特流**(0、1序列)与**电压**的高低、光的**闪灭**之间的**互换**。

### 1.7 传输方式的分类

通过网络发送数据，大致可分为**面向有连接**与**面向无连接**两种类型。

**面向有连接型** 中，在发送数据之前，需要在收发主机之前连接一条通信线路。面向有连接型就好像人平常打电话，输入完对方电话号码播出之后，只有对方端拿起电话才是真正通话。

**面向无连接型**则不要求建立和断开连接。**发送端可于任何时间发送数据**，接收端则永远不知道自己会在何时从哪里接收数据，因此，**接收端需要**时常**确认是否收到了数据**。

目前，网络通信方式大致分为两种——**电路交换**和**分组交换**。

网络通信当中，也可以根据目标地址的个数及后续的行为对通信进行分类。如广播多播就是这种分类的产物。

分为单播，广播，多播，任播。

**单播**：比如早先的固定电话，1对1通信。

**广播**：典型例子就是电视播放，将电视信号一齐发送非非特定的多个接受对象。

**多播**：和广播类似，不同的是要限定某一组主机为接收端。

**任播**：在特定的多台主机中选出一台作为接受端。

### 1.8 地址

**一个地址必须明确地表示一个主体对象**，在同一个通信网络中不允许由两个相同地址的通信主体存在，这就是地址的**唯一性**。 

当地址总数越来越多时，如何高效的从中找出通信的目标地址成为一个重要的问题。为此人们发现地址除了具有唯一性还需要具有**层次性**。

### 1.9 网络的构成要素

**网卡**。任何一台计算机连接网络时，必须使用网卡（全称是网络接口卡）。网络接口卡（NIC）有时也被叫做网络适配器，网卡，LAN卡。

**中继器**———是OSI模型的第一层，**物理层**面延长网络的设备。由电缆传来的电信号或光信号经由中继器的波形调整和放大再传给另一个电缆。

**网桥/2层交换机**在OSI模型的第2层———**数据链路层面**上连接两个网络的设备。它能够识别数据链路层的数据帧（与分组数据意思大致相同，但是在数据链路层习惯称为帧），并将这些数据帧临时储存于内存，再重新生成信号作为一个全新的帧转发给另一个网段。

**路由器/3层交换机** 是在OSI模型的第3层———**网络层**面连接两个网络，并对分组报文进行转发的设备。网桥是根据物理地址（MAC地址）进行处理，而路由器/3层交换机则是根据IP地址进行处理的。路由器可以连接到不同的数据链路。

**4~7层交换机** 负责处理OSI模型中从**传输层到数据层的数据**。如果有TCP/IP分层模型，4~7层交换机就是以TCP等协议的传输层机器上面的应用层为基础，分析收发数据，并对其进行特定的处理。

**网关**是OSI模型中负责**从传输层到应用层的数据进行转换和转发**的设备。网关不仅转发数据还对数据进行转换，它通常会使用一个表示层或应用层网关，在两个不能进行直接通信的协议之间通信，最终实现两者之间的通信。

### 1.10 现代网络时态

我们以交通道路为例说明现实当中的网络配置。

高速公路的 “骨干” 或 “核心” 相当于**计算机网络的中心**（核心网、骨干网），人们通常选用高速路由器相互连接使之快速传递大量数据。

网络中相应于高速公路出入口的部分被称为 **“边缘网络”**（网络边界） ，常用的设备有**多功能路由器和3层交换机**。

高速公路出入口连接出国道，省道，从而可以直接通往市区街道对应计算机网络中连接 “边缘网络” 的部分叫做 “**接入层**” 或 “**汇聚层**” 。

## 第二章 TCP/IP 基础知识

### 2.4 TCP/IP 基础模型

**硬件 (物理层):** TCP/IP的最底层是**负责数据传输的硬件**，相当于以太网或电话线路等物理层的设备。

**网络接口层 (数据链路层):** 网络接口层是**利用以太网中的数据链路进行通信**，因此属于接口层。也就是说，把它当作让NIC起作用的“驱动程序”也无妨。计算机添加外设或拓展卡需要相应驱动的支持。因此，人们常常还需要在操作系统的基础上安装一些驱动软件以便使用这些附加硬件。

**互联网层 (网络层):** 互联网层 **使用 IP 协议**，相当于OSI模型中的第3层网络层。IP协议基于IP地址转发分包数据。

**传输层:** 传输层最主要的功能就是能够**让应用程序之间实现通信**，计算机内部通常同一时间运行着多个程序，为此，必须分清是哪些程序与哪些程序在进行通信，识别这些应用程序的是**端口号**。

- **TCP**: TCP是一种**面向有连接的传输层协议**，它可以保证两端通信主机之间的通信可达。 TCP 能够正确 **处理在传输过程中丢包、传输顺序乱掉等异常情况** 。此外, TCP 还能够有效利用带宽,缓解网络拥堵。然而,为了建立与断开连接,有时它需要至少7次的发包收包,导致网络流量的浪费。此外,为了提高网络的利用率, TCP 协议中定义了各种各样复杂的规范,因此不利于视频会议(音频、视频的数据量既定)等场合使用。
- **UDP**：UDP和TCP不同，它是一种**面向无连接的传输层协议**，因为面向无连接的特性，UDP不会关注对端是否真的收到了数据，可以在应用程序中实现此功能。UDP常用于分组数据较少或多播，广播通信以及视频通信等多媒体领域。

**应用层（会话层以上的分层）** TCP/IP的分层中，将OSI模型中**会话层**，**表示层**和**应用层**的功能都集中到了**应用程序来实现**。

**TCP/IP 应用的架构** 绝大多数属于 **客户端/服务端**模型，**提供服务的程序叫服务端**，**接收服务的程序叫客户端**。在这种通信模式中，**提供服务的程序**会预先被**部署到主机**上，等待接收任何时刻客户可能发送的要求。客户端可以随时发送请求给服务端，有时服务端可能会有处理异常，超出负载等情况，这时客户可以在等待片刻后重发一次请求。

- WWW（万维网）可以说是互联网能够如此普及的一个重要原动力。用户在一种叫做游览器的软件上借助鼠标和键盘就可以轻轻松松地在网上冲浪（从今天来看，这个解释真的感觉好古老~)。浏览器和服务端通信使用的 **协议** 是 **HTTP** ，所传输数据的主要格式是**HTML**。WWW中的 **HTTP属于OSI应用层的协议** ，而 **HTML属于表示层** 的协议。

- 电子邮件：电子邮件就是在网络上发送信件，发送电子邮件用到的协议叫做**SMTP**。最初，人们只能发送文本格式的电子邮件，但现在，电子邮件格式由**MIME**协议拓展以后，就可以发送声音，图像等各式各样的信息，甚至修改邮件文字的大小，颜色。

- 文件传输（FTD）：文件传输是指将保存在其他计算机硬盘上的文件转移到本地的硬盘上，或将本地硬盘的文件传送到其他机器硬盘上的意思。该过程使用的协议叫做**FTP**，FTP很早就已经投入使用，传输过程中可以选择用二进制还是文本方式。在FTP中进行文件传输时会建立两个TCP连接，分别是发出传输请求时所要用到的控制连接与实际传输数据时所要用到的连接。（属于OSI**会话层**的功能）

- 远程登陆（TELNET与SSH）：远程登陆是指登录到远程的计算机上，使那台计算机上的程序得以运行的一种功能。TCP/IP网络中远程登陆常用**TELNET**与**SSH**两种协议。

- 网络管理（SNMP)：TCP/IP 中进行**网络管理**时，采用 SNMP 协议。使用SNMP管理的主机，网桥，路由器等称作SNMP代理，而进行管理的那一段叫做管理器，SNMP正是这个管理器和代理所要用的协议。在 SNMP 的代理端,保存着网络接口的信息、通信数据量、异常数据量以及 设备温度等信息。这些信息可以通过 MIB ( Management Information Base )访问。因此,在 TCP / IP 的网络管理中, SNMP 属于应用协议, MIB 属于表示层协议。一个网络范围越大,结构越复杂,就越需要对其进行有效的管理。而 SNMF 可以让管理员及时检查网络拥堵情况,及早发现故障,也可以为以后扩大网络收集必要的信息。

### 2.5 TCP/IP 分层模型通信实例

**每个分层**中，都会对所发送的数据**附加一个首部**，包含了该层必要的信息，如发送的目标地址以及协议相关信息。通常，为协议提供的信息是包首部，所要发送的内容是数据。

**论包、帧、数据报、段、消息**

**包**可以说是全能性述语。**帧**用于表示数据链路层中**包的单位**。而**数据报**是 **I** 和 **UDP** 等网絡层以上的分层中包的单位。**段**则表示 TCP 数据流中的**信息**。最后,**消息**是指应用协议中**数据的单位**。

**经过数据链路的包**

每个**包首部**中至少都会包含两个信息：一个是**发送端和接收端的地址**，另一个是**上一层的协议类型**。

经过每个协议分层时，都必须有识别包发送端和接收端的信息。**以太网**会用**MAC**地址，**IP**会用**IP地址**，而**TCP/UDP**会用**端口号**作为识别两端主机的地址。

此外，**每个分层**的**包首部**中还包含一个**识别位**，它是用来**标识上一层协议的种类信息**，例如**以太网**的包首部中的**以太网类型**，**IP**中的**协议类型**以及**TCP/IP**中**两个端口的端口号**等都起着标识协议类型的作用。

## 第三章 数据链路

### 3.1 数据链路的作用

**数据链路**，指的是OSI参考模型中的**数据链路层**，有时也指**以太网**，**无线局域网等通信手段**。

**数据链路层的段**是指一个被分割的网络，根据使用者的不同，含义也不禁相同。

**网络拓朴**

网络的连接和构成的形态称为网络拓扑，网络拓扑包括总线型，环型，星型，网状型等。拓扑一词不仅适用于直观可见的配线方式上，也用于逻辑上网络的组成结构，两者有时可能不一致。

### 3.2 数据链路相关技术

**3.2.1 MAC地址**

MAC地址用于识别数据链路中互联的节点。

MAC地址长48比特，在使用网卡（NIC）的情况下，MAC地址一般会被烧入到ROM中，因此，任何一个网卡的MAC地址都是唯一的。

 关于厂商识别码，每个NIC厂商都有特定唯一的识别数字。

> 在全世界，MAC地址也并不总是唯一的，实际上，即使MAC地址相同，只要不是同属同一个数据链路就不会出现问题。

从通信介质的使用方法来看，网络可分为**共享介质层**和**非共享介质层**。

**共享介质层** 是指多个设备共享一个通信介质的一种网络（以太网，FDDI）。设备之间使用同一个载波信息进行发送与接收，并有必要对介质进行控制访问。

有两种介**质访问控制方式**：一种是**争用方式**，另一种是**令牌传递方式**。

- **争用方式** 是指争夺数据传输的权力，也叫CSMA（载波监听多路访问），这种方式令网络的各个站（节点）采用先到先得的方式占用信道发送数据，如多个站同时发送帧，则会产生冲突现象。
- **令牌传递方式** 是沿着令障环发送一种叫做“令牌”的特殊报文,是控制传输的一种方式。只有获得令牌的站オ能发送数据。这种方式有两个特点: 一是不全有冲突,二是每个站都有通过平等循环获得令牌的机会。因此,即使网络拥堵也不会导致性能下降。

**非共享介质网络**  不共享介质，是对介质采用专用的一种传输控制方式。在这种方式下，每个站直连交换机，由交换机负责转发数据帧。

**根据MAC地址转发**

在使用同轴电缆的以太网(10BASE5、10BASE2)等介质共享网络中,同一时间只能有一台主机发送数据。当连网的主机数量增加时,通信性能会明显下降。若将集线器或集中器等设备以星型连接,就出现了一款新的网络设备一交換集线器,这是一种将非介质共享型网络中所使用的交換机用在以太网中的技术,交换集线器也叫做以太网交换机。

以太网交换机就是持有多个端口”的网桥。它们根据數据链路层中每个帧的目标 MAC 地址,决定从哪个网络接口发送数据。这时所参考的、用以记录发送接口的就叫做转发表( Forwarding Table )。

**环路检测技术**

通过网桥连接网络时,一且出现环路该如何处理?这与网络的拓扑结构和所使用的网桥种类有直接关系。最坏的情况下,数据帧会在环路中被一而再再而三地持续转发。而一且这种数据帧越积越多将会导致网络瘫痪。

解决网络中的环状问题，具体有生成树和源路由两种方式。只要搭建合适的网桥，在发生某一处路由故障时绕行，可以提高容灾能力。

- 生成树方式: 每个网桥必须在每1~10秒内相互交换BPDU包，从而判断哪些端口使用哪些不使用，以便消除环路。一旦发生故障就会自动切换通信线路，利用那些没有被使用的端口继续进行传输。
- 源路由法: 源路由法最早由IBM提出，以解决令牌环网络问题。该办法可以判断发送数据的源地址是通过哪个网桥实现传输的，并将帧写入RIF。网桥则根据这个RIF信息发送帧给目标地址。在这种机制中发送端本身必须具备源路由的功能。

**VLAN**

进行网络管理的时候,时常会遇到分散网络负载、变换部署网络设备的位置等情况。而有时管理员在做这些操作时,不得不修改网络的拓扑结构,这也就意味着必须进行硬件线路的改造。然而,如果采用带有 VLAN 技术的网桥,就不用实际修改网络布线,只需修改网络的结构即可。

### 3.3 PPP

PPP是点对点，即1对1的协议。PPP相当于OSI模型第二层的**数据链路层**。

**PPP的帧格式**

其中标识符用来区分每个帧，PPP是基于HDLC，HDLC就是在每个帧的前后加上一个8位字节“01111110”用来区分帧。

**PPPoE**

有些互联网接入服务商在以太网上利用PPPoE提供PPP功能。

在这种互联网接人服务中,通信线路由以太网模报。由于以太网越来越普及在加上它的网络设备与相应的 NIC 价格比较便宜,因而 ISP 能够提供一个单价更低的互联网按人服务。

单纯的以太网没有验证功能,也没有建立和断开连接的处理,因此无法按时计费。而如果果用 PPPoE 管理以太网连接,就可以利用 PPP 的验证等功能使各家 ISP 可以有效地管理终端用户的使用。

## 第四章 IP 协议

### 4.1 IP 即网络协议

TCP/IP的心脏是互联网层，这一层主要由**IP**和**ICMP**两个协议组成，本章仅对IP协议进行详细说明。目前的IP4已经无法应对互联网的需求，于是出现了更高版本的IP6。

**IP相当于OSI模型的第3层**

IP相当于OSI参考模型的第3层——网络层。

**网络层**的主要功能是“**实现终端节点之间的通信**”，这种终端节点之间的通信也叫“**点对点通信**”。

从上一章知道，**数据链路层**的主要作用是**在互联同一种数据链路的节点之间进行包传输**。而一旦跨越多种数据链路，就需要借助网络层。

**主机与节点**

在互联网世界中,将那些配有 IP 地址的设备叫做“主机”。这里的主机可以是超大型计算机,也可以是小型计算机。这是因为互联网在当初刚发明的时候,只能连接这类大型的想势设备,因此习慣上将配有 IP地址的设备称为“主机”。

然而,准确地说,主机的定义应该是指“配置有 IP 地址,但是不进行路由控制＂的设备”。既配有 IP 地址又具有路由控制能力的设备叫做“路由器”,跟主机有所区别。而**节点**则是主机和路由器的统称”。

**网络层和网络链路层的关系**

数据链路层提供直连两个设备之间的通信功能，网络层的IP则负责在没有直连的两个网络之间进行通信传输，它们的区别又是什么呢？

就好像我们坐火车或飞机旅游，每张票只能在某一限定区间内移动。此处的 “**区间内**” 就如同通信网络上的**数据链路**，而这个区间内的**出发地点和目的地点**就如同某一个数据链路的**源地址和目标地址**等首部信息。整个全程的**行程表**的作用就相当于**网络层**。

### 4.2 IP 基础知识

IP大致分为三大作用模块，它们是**IP寻址**，**路由**（最终节点为止的转发），以及**IP分包与组包**。

通信中为了实现通信对端，必须要有一个类似于地址的识别码进行标识，MAC是标识同一种链路中不同计算机的一种识别码。网络层的IP也有这种地址信息，一般也叫IP地址。IP地址用于在“连接到网络中的所有主机识别出进行通信的目标地址”。因此，在**TCP/IP通信中**所有主机或路由器**必须设定自己的IP地址**

不论主机与哪种数据链路层连接，其IP地址的形式都保持不变。另外，在网桥或交换集线器等物理层设备中，不需要设置IP地址。

**路由控制** 

将分组数据发送到最终目标地址的功能。一旦这个路由控制的运行出现异常，分组数据极有可能“迷失”，无法到达目标地址。因此，一个数据包之所以能够成功地到达最终地目标地址，全靠路由控制。

**多跳路由**

Hop 译为中文叫“跳”。它是指网络中的一个区间。IP包正是在网络中一个个跳间被转发。因此路由也叫做**多跳路由**。在每一个区间内决定着包在下一跳被转发的路径。

多跳路由是指路由器或主机在转发 IP 数据包时只指定下一个路由器或主机,而不是将到最终目标地址为止的所有通路全都指定出来。因为每一个区间(跳)在转发 IP 数据包时会分别指定下一跳的操作,直至包达到最终的目标地址。如图,以乘坐火车旅游为例具体说明

**路由控制表**

为了将数据包发给目标主机,所有主机都维护着一张路由控制表( **Routing Table** )。该表**记录** IP 数据在**下一步应该发给哪个路由器**。IP包将根据这个路由表在各个数据链路上传输。

**数据链路的抽象化**

IP是实现多个数据链路之间通信的协议，数据链路根据种类的不同各有特点，对这些不同的数据链路的相异特性抽象化也是IP的重要作用之一。

**IP属于面向无连接型**

IP 采用面向无连接主要有两点原因; 一是为了简化,二是为了提速。面向连接比起面向无连技处理相对复杂。甚至管理每个连接本身就是一个相当紧琐的事情。此外,每次通信之前都要事先建立连淡,又会降低处理速皮。需要有连接时,可以委托上一层提供此项服务。因此, I 为了实现简单化与高速化采用面向无连接的方式。

### 4.3 IP 地址基础知识

用 TCP / IP 通信时,用 IP 地址识别主机和路由器。为了保证正常通信,有必要为每个设备配置正确的 IP 地址。在互联网通信中,全世界都必须设定正确的 IP 地址。否则,根本无法实现正常的通信。因此, **IP 地址就像是 TCP / IP 通信的一块基石**。

**IP地址的定义**

IPv4地址由**32位正整数**来表示，TCP/IP通信要求将这样的IP地址分配给每一个参与通信的主机。IP地址在计算机内部以二进制方式被处理，然而人类并不习惯采用二进制方式，需要采用一种特殊的标记方式，那就是将32位的IP地址以每8位为一组分为四组，每组以“.”隔开，再将每组数转换为十进制数。

**IP地址由网络和主机两部分组成** 

网络标识在数据链路的每个段配置不同的值，必须保证连接的每个段的地址不相重复。而相同段内相连的主机必须有相同的网络地址，IP地址的“主机标识‘则不允许在同一个网段内重复出现。

也因此，可以通过设置**网络地址**和**主机地址**，在相互连接的整个网络中保证每台主机的IP都不会重叠，即IP有了**唯一性**。

**IP地址的分类**

IP地址分为A类，B类，C类，D类 四类。根据IP地址中第1位到第4位的比特对其网络标识和主机识别进行区分。

- A类IP地址: 首位以“0”开头的地址。从第1位到第8位是它的网络标识用十进制表示的话, 0.0.0.0-127.0.0.0是 A 类的网絡地址。 A 类地址的后24位相当于主机标识。因此,一个两段内可容纳的主机地址上限为16,777,214个。
- B 类 IP 地址: 前两位为“10”的地址。从第1位到第16位’是它的网络标识。用十进倒表示的话，128.0.0.1~191.255.0.0是 B 类的网络地址。 B 类地址的后16位相当于主机标识。因此,一个网段内可容纳的主机地址上限为65,534个＂。
- C 类护地址: 前三位为“110”的地址。从第1位到第24位是它的网络标识。用十进制表示的话,192.168.0.0-239.255.255.0是 C 类的网络地址。 C类地址的后8位相当于主机标识。因此,一个网段内可容纳的主机地址上限为254个。
- D类护地址: 前四位为“1110”的地址。从第1位到第24位是它的网络标识。用十进制表示的话,224.0.0.0-239.255.255.255是 D 类的网絡地址。D 类地址没有主机标识,常被用于多播。

**广播地址**

广播地址用于在同一个链路中相互连接的主机之间发送数据包，IP地址中的主机地址部分全部设置为1，就成了广播地址。 

广播分为**本地广播**和**直接广播**。在本网络内的叫做本地广播，在不同网络之间的广播叫做直接广播。

**IP多播**

多播用于将包发送给特定组内的所有主机，由于其直接使用IP协议，因此也不存在可靠传输。

**IP多播与地址**

多播使用D类地址，因此如果从首位开始到第4位是”1110“，就可以认为是多播地址，而剩下的28位可以成为多播的组编号。

**子网与子网掩码**

现在,一个IP地址的网络标识和主机标识已不再受限于该地址的类别,而是由一个叫做“**子网掩码**”的识别码通过子网网络地址细分出比 A 类、B 类、C 类更小粒度的网络。这种方式实际上就是将原来 A 类、B 类 ，C 类等分类中的主机地址部分用作子网地址,可以将原网络分为多个物理网络的一种机制。自从引人了子网以后,一个 IP 地址就有了**两种识别码**。一是IP地址本身，另一个是表示网络部的子网掩码。子网掩码用二进制方式表示的话,也是一个32位的数字。它对应**IP地址网络标识部分的位全都为“1”**，对于**IP 地址主机标识的部分则全部为“0”**。由此,一个IP地址可以不再受限于自己的类别,而是可以用这样的子网掩码自由地定位自己的网络标识长度。当然,子网掩码必须是IP地址的首位开始连续的"1".

**全局网络和私有网络**

起初，互联网中的任何一台主机或路由都必须配一个唯一的IP地址，可随着互联网的发展，如果采用唯一地址的话，会有IP地址耗尽的风险。于是出现了一种新技术，只要求在必要的时候为相应数量的设备分配唯一的IP地址。

每个独立的网络各自设置IP地址也可能存在问题，于是出现了私有网路的IP地址, 如下

- A: 10.0.0.0~10.255.255.255 即 10.0.0.0/8
- B: 172.16.0.0~172.31.255.255 即 172.16.0.0/12
- C: 192.168.0.0~192.168.255.255 即 192.168.0.0/16

### 4.4 路由控制

发送数据包所使用的地址是网络层的地址，即IP地址。仅有IP地址还不足以实现将数据包发送到对端目标地址，在数据发送中还需要有类似于“指明路由器或主机”的信息，以便发往目标地址。保存这种信息的就是**路由控制表**，实现IP通信的主机和路由器都必须持有一张这样的表。

路由控制表的形成方式有两种：一种是**管理员手动设置**，另一种是路由器与其他路由器相互交换信息时**自动刷新**。

该表是由一个叫做“**路由协议**”的协议制作而成。

**IP地址与路由控制**

IP地址的网络地址部分用于进行路由控制。

路由控制表记录着网络地址与下一步应该发送至路由器的地址。

- 默认路由: 如果一张路由表中包含所有的网络及其子网的信息，将会造成无端的浪费，这是默认路由是很好的选择，默认路由是指**路由表中任何一个地址都能与之匹配的记录**。
- 主机路由: “IP地址/32”被称为主机路由，它的意思是整个IP地址的所有位都将参与路由，意味着要**基于主机上网卡上配置的IP地址**本身，而不是基于该地址的网络地址部分进行路由。
- 环回地址: 环回地址是在同一台计算机上的程序之间进行网络通信时所使用的一个默认地址。

**路由控制表的聚合（路由汇总）**

利用网络地址的比特分布可以有效地进行分层配置，对被即使有多个子网掩码，对外呈现出的也是同一个网络地址，这样可以更好的构建网络。

### 4.6 IPv6

**IPv6的必要性**

IPv6是为了根本解决IPv4地址耗尽的问题而被标准化的网际协议。IPv4的地址长度为4个8位字节，而IPv6的地址长度则是原来的4倍，一般写为8个16位字节。但替换IP地址会是更为艰巨的任务。

**IPv6的特点**

IPv6具有以下几个特点，这些功能的一部分在IPv4中已经得以实现。而IPv6则将这些统统作为必要的功能，减少了管理员的负担。

- IP地址的扩大与路由控制表的聚合: IP 地址依然适应互联网分层构造。分配与其地址结构相适应的 IP 地址,尽可能避免路由表膨大。
- 性能提升: 包首部长度采用固定的值(40字节),不再采用首部检验码。简化首部结构,减轻路由器负荷。路由器不再做分片处理(通过路径 MTU 发现只由发送端主机进行分片处理)。
- 支持即插即用功能: 即使没有 DHCP 服务器也可以实现自动分配 IP 地址。
- 支持即插即用功能: 即使没有 DHCP 服务器也可以实现自动分配 IP 地址。

**IPv6中IP地址的标记方法**

IPv6地址长度为128位，能表示的数字高达38位，足以包含人们所能想到所有主机和路由器分配地址。

如果将IPv6也用十进制数据表示的话，是16个数字的序列。但用16个数字序列表示显得麻烦，因此，将128比特IP地址以每16比特为一组，每组用冒号（；）隔开进行标记，而且如果出现连续的0时还可以将这些0省略，并用两个冒号（：：）隔开，但是**一个IP地址中只允许出现一两个连续的冒号**。

**IPv6地址的结构**

IPv6类似IPv4，也是通过IP地址的前几位标识IP地址的种类。

在互联网通信中,使用一种全局的单播地址。它是互联网中唯一的一个地址,不需要正式分配 IP 地址。

**全局单播地址**

全局单播地址是指世界上唯一的一个地址，它是互联网通信以及各个域内部通信中最为常用的一个IPv6地址。现在IPv6的网络中所使用的格式为，n = 48，m = 16以及128-n-m = 64，即前64比特为网络标识，后64位为主机标识。

## 第五章 IP 协议相关技术

### 5.2 DNS

我们平常在访问某个网站时不使用 IP 地址,而是用一串由罗马字和点号组成的字符串。而一般用户在使用 TCP / IP 进行通信时也不使用 IP 地址。能够这样做是因有了 DNS ( Domain Name System )功能的支持。 DNS 可以将那串字符串自动转换为具体的 IP 地址。

**IP地址不便记忆**

TCP/IP要求每一个互联的计算机都具有其唯一的IP地址，并基于这个IP地址进行通信。但IP地址是由一串数据序列组成，并不好记。

为此，就有了一种叫做主机识别码的东西。这种识别方式是指为每台计算机赋以唯一的主机名，在进行网络通信时可以直接使用主机名称而无需输入一长串的IP地址。并且此时，系统必须自动将主机名转换为具体的IP地址。为了实现这样的功能，主机往往会利用一个叫做hosts文件才能正常使用网络。但随着网络规模的扩大，这种方式慢慢变得不再适用。

**DNS的产生**

在上述背景下，产生了一个可以有效管理主机名和IP地址之间对应关系的系统，那就是DNS系统。可以用来维护一个表示组织内部主机和IP地址之间对应关系的数据库。

**域名的构成**

在理解DNS规范时，首先要理解什么是域名，域名是指为了识别主机名称和组织机构名称的一种具有分层的名称。

DNS的分层如下所示，由于看起来像一颗倒挂的树，人们也把这种分层结构叫做**树形结构**。

**DNS查询**

解析器为了调查IP地址，向域名服务器进行查询处理，接收这个查询请求的域名服务器首先会在自己的数据库进行查找，如果有该域名对应的IP地址就返回。如果没有，则域名服务器在向上一层根域名服务器进行查询处理。

解析器和域名服务器将最新了解到的信息暂时保存在缓存里。这样，可以减少每次查询时的性能消耗。

**DNS如同互联网中的分布式数据库**

DNS是一种通过主机名检索IP地址的系统。然而，它所管理的信息不仅仅是这些主机名和IP地址之间的映射信息。

它还要管理众多其他信息，例如，主机名与IP地址的对应信息叫做A记录。反之，从IP地址检索主机名称的信息叫做PTR。此外，上层或下层域名服务器IP地址的映射叫做NS记录。

在此特别需要指出的是MX记录，这类记录中注册了邮件地址与邮件接收服务器的主机名。

### 5.3 ARP


只要确认了IP地址，就可以向这个目标地址发送IP数据报。然而，在底层数据链路层，进行实际通信时却有必要了解每个IP地址所对应的MAC地址。

**ARP概要**

ARP是一种解决地址问题的协议。以目标IP为线索，用来定位下一个应该接收数据分包的网络设备对应的MAC地址。

**ARP的工作机制**

那ARP是如何知道MAC地址的呢？

ARP是借助**ARP请求**与**ARP响应**两种类型的包确认MAC地址的。

主机A为了获得主机B的MAC地址，起初要通过**广播发送**一个**ARP请求包**。这个包中包含了想要了解其MAC地址的IP地址，由于广播的包可以被同一条链路上的所有主机和路由器进行解析，如果请求包的IP地址与自己的IP地址一致，那么这个节点就将自己的MAC地址塞入ARP响应包返回给主机。

**IP地址和MAC地址缺一不可**

尽管数据链路层需要MAC就可发送，IP一个广播（浪费流量）就能发送到区间段。但发送给其他数据链路的某一个主机，就需要两者结合了。

**代理ARP**

通常ARP包会被路由器隔离，但是使用代理ARP的路由器可以将ARP请求转发给相邻的网段。由此，两个以上网段的节点之间可以像在同一个网段中一样通信。

### 5.4 ICMP

**辅助IP的ICMP**

架构IP网络时要特别注重两点：确认网络是否正常工作，以及遇到问题时进行问题诊断。

例如,一个刚刚搭建好的网络,需要验证该网络的设置是否正确。此外,为了确保网络能够按照预期正常工作,一且遇到什么问题需要立即制止问题的蔓延。为了减轻网络管理员的负担,这些都是必不可少的功能。 ICMP 正是提供这类功能的一种协议。

**ICMP 的主要功能**包括,确认IP包是否成功送达目标地址,通知在发送过程当中IP包被废弃的具体原因,改善网络设置等。有了这些功能以后,就可以获得网络是否正常、设置是否有误以及设备有何异常等信息,从而便于进行网络上的问题诊断。

ICMP的消息大致可以分为两类：一类是**通知出错的错误信息**，另一种是用于**诊断的查询信息**。

**主要的ICMP信息**

- **ICMP目标不可达信息**: IP路由器无法将IP数据包发送给目标地址时，会给发送端主机返回一个目标不可达的ICMP信息，并在这个消息中显示不可达的具体原因。
- **ICMP目标重定向信息**: 如果路由器发现发送端主机使用了次优的路径发送数据，那么它会返回一个ICMP重定向的消息给这个主机。在这个消息中包含了最合适的路由信息和数据。这主要发生在路由器持有更好路由信息的情况下。路由器会通过这样的ICMP消息给发送端主机一个更合适的发送路由。
- **ICMP目标超时信息**: IP包中有一个字段叫做TTL（生存周期），它的值随着每经过一次路由器就会减1，直到减到0该IP包会被丢弃。此时，IP路由器将会发送一个ICMP超时的信息，并通知该包已被丢弃。
- **ICMP目标回送信息**（类型0，8）用于进行通知的主机或路由器之间，判断所发送的数据包是否已经成功到达对端的一种信息，可以向对端主机发送回送请求的消息（类型8），也可以接收对端主机发回来的回送应答消息（类型0）。

**ICMPv6**

IPv4中ICMP仅作为一个辅助功能，但在IPv6中，ICMP的作用被扩大，如果没有IPMv6,IPv6就无法实现正常通信。

ICMPv6中大致分为两类：一类是**错误信息**，另一类是**信息消息**。类型0~127属于错误消息，128~255属于信息消息。

**邻居探索**

ICMPv6中从类型133至137的消息叫做邻居探索信息。**邻居请求**信息用于查询IPv6的地址与MAC地址的对应关系，并由邻居宣告得知MAC地址。邻居请求信息利用IPv6的多播第hi实现传输。

### 5.5 DHCP

**DHCP实现即插即用**

如果逐一为每一台计算机设置IP地址会是非常繁琐的事，于是为了实现自动设置IP地址，统一管理IP地址分配，就产生了DHCP协议。有了DHCP，即插即用变成可能。

**DHCP的工作机制**

使用DHCP之前，首先要架设一台**DHCP服务器**，然后将DHCP所要分配的IP地址设置到服务器上。从DHCP中获取IP地址的流程，简单来说，主要分为两个阶段。

### 5.6 NAT

**NAT定义**

NAT是用于本地网络中使用私有地址，在连接互联网时转而使用全局IP地址的技术。除转换IP地址外，还出现了可以转换TCP,UDP端口号的NAPT技术。由此可以实现一个全局IP地址与多个主机的通信。

**NAT的工作机制**

NAT服务器内部，有一张自动生成的用来转换地址的表。当私有网络内的多台机器同时都要与外部进行通信时，仅仅转换IP地址，人们不免担心全局IP地址是否不够用。这时采用包含端口号一起转换的方式可以解决这个问题。 

### 5.7 IP 隧道

为了让不同协议 (如 IPv4 和 IPv6)之间正常通信，这时必须采用**IP隧道**的功能。

IP隧道可以将那些从网络A发过来的**IPv6**的包**统和**为一个数据，再为之**追加**一个**IPv4的首部**以后转发给网络C。

一般情况下，紧接着IP首部的时TCP或UDP的首部，然而，现在应用当中“IP首部的后边还是IP首部”或“IP首部的后面是IPv6的首部”等情况日益俱增。这种再网络层后面继续追加网络层首部的通信方法就叫做“IP隧道”。

## 第六章 TCP与UDP

### 6.1 传输层的作用

TCP/IP中有两个具有代表性的传输层协议，它们分别是TCP和UDP。TCP提供**可靠**的通信传输，UDP则常被用于让广播和细节控制交给应用的通信传输。

**传输层定义**

IP首部中有一个协议字段，用来标识网络层的上一层采用的是哪一种传输层协议。

传输层的TCP和UDP，为了识别自己所传输的数据部分究竟应该发给哪个应用，也设置了这样一个编号。

以包裹为例,邮递员( IP )根据收件人地址(目标IP地址)向目的地(计算机)投递包裹( IP数据报)。包裏到达目的地以后由对方(传输层协议)根据包裘信息判断最终的接收人(接收端应用程序)。

**通信协议**

TCP / IP 的众多应用协议大多以客户端/服务端的形式运行。客户端类似于客户的意思,是请求的发起端。而服务端则表示提供服务的意思,是请求的处理端。另外,作为服务端的程序有必要提前启动,准备接收客户端的请求。否则即使有客户端的请求发过来,也无法做到相应的处理。

**两种传输层协议TCP和UDP**

- **TCP:** 是**面向连接**的，**可靠的流协议**。流就是指**不间断**的数据结构。当应用程序采用TCP发送消息时，虽然可以保证发送的顺序，但还是犹如没有任何间隔的数据流发送给接收端。
- **UDP:** 是不具有可靠性的数据报协议。细微的处理它会交给上是的应用去完成。在 UDP 的情况下,虽然可以确保发送消息的大小,却不能保证消息一定会到达。

**TCP 与 UDP 的区别**

TCP可靠, UDP高效

### 6.2 端口号

**端口号定义**

数据链路和IP中的地址，分别指的是MAC地址和IP地址。前者用来识别同一链路中不同的计算机,后者用来识别 TCP / IP 网络中互连的主机和路由器。在传输层中也有这种类似于地址的擬念,那就是端口号。**端口号**用来**识别同一台计算机**中进行通信的**不同应用程序**。因此,它也被称为程序地址。

**根据端口号识别应用**

一台计算机上可同时运行多个程序，传输层协议正是利用这些端口号识别本机中正在进行通信的应用程序。

**端口号如何确定**

确认端口号的方法分为两种：

- 标定即成的端口号: 这种方法也叫静态方法。它是指每个应用程序都有其指定的端口号。但并不亜器是说可以随意使用任何一个端口号。每个端口号都有其对应的使用目的。
- 时序分配法: 此时，服务器有必要确定监听段端口号，但是接收服务的客户端没必要确认端口号。在这种方法下,客户端应用程序可以完全不用自己设置端口号,而全权交给操作系统进行分配。操作系统可以为每个应用程序分配互不冲突的端口号。例如每需要一个新的缩口号时,就在之前分配号码的基础上加1。这样,操作系統就可以动态地管理端口号了。动态分配到端口号取值范围在49152到65535之间

**端口号与协议**

**端口号由其使用的传输层协议决定**。因此,**不同的传输协议可以使用相同的端口号**。例如, TCP 与 UDP 使用同一个端口号,但使用目的各不相同。这是因为端口号上的处理是根据每个传输协议的不同而进行的。 


数据到达IP层后,会先检查 IP 首部中的协议号,再传给相应协议的模块如果是 TCP 则传给 TCP 模块、如果是 UDP 则传给 UDP 模块去做端口号的处理即使是同一个端口号,由于传输协议是各自独立地进行处理,因此相互之间不会受到影响。

### 6.3 UDP

**UDP的特点及其目的**

UDP不提供复杂的控制机制，利用IP提供面向无连接的通信服务。并且它是将应用程序发来的数据在收到的那一刻，立刻按照原样发送到网络上的一种机制。

由于 UDP 面向无连接,它可以随时发送数据。再加上 UDP 本身的处理既**简单又高效**,因此经常用于以下几个方面:

 - 包总量较少的通信( DNS 、 SNMP 等)
- 视频、音频等多媒体通信(即时通信)
- 限定于 LAN 等特定网络中的应用通信
- 广播通信(广播、多播)

### 6.4 TCP

与UDP不同，TCP是对 “**传输，发送，通信**” 进行“**控制**”的“协议”。

TCP 与 UDP 的区别相当大。它充分地实现了数据传输时各种**控制功能**,可以进行丢包时的**重发控制**,还可以对次序乱掉的分包进行**顺序控制**。而这些在 UDP 中都没有。此外, TCP 作为一种面向有连接的协议,只有在确认通信对端存在时才会发送数据,从而可以控制通信流量的浪费。

根据 TCP 的这些机制,在 IP 这种无连接的网络上也能够实现高可靠性的通信。

**TCP的特点及其目的**

为了通过 IP 数据报实現可靠性传输,需要考虑很多事情,例如数据的破坏丢包、重复以及分片順序混乱等问题。如不能解决这些问题,也就无从谈起可靠传输。 TCP 通过检验和、序列号、确认应答、重发控制、连接管理以及窗口控制等机制实现可靠性传输。

**通过序列号与确认应答提高可靠性**

在TCP中，当发送端的数据到达接受主机时，接收端主机会返回一个已收到消息的通知，这个信息叫做**确认应答**。

在一定时间内没有等到确认皮答,发送端就可以认为数据已经丢失,并进行重发。由此,即使产生了**丢包**,仍然能够保证数据能够到达对端，实现**可靠传输**。

未收到确认应答并不宜味着数据一定丢失。也有可能是数据对方已经收到只是**返回的确认应答在途中丢失**。这种情况也会导致发送端因没有收到确认应答,而认为数据没有到达目的地,从而进行重新发送。如下图所示。

**重发超时如何确定**

重发超时是指在重发数据之前,等待确认应答到来的那个**特定时间间隔**。如果超过了这个时间仍未收到确认应答,发送端将进行数据重发。那么这个重发超时的具体时间长度又是如何确定的呢?

最理想的是,找到一个最小时间,它能保证 “**确认应答一定能在这个时间内返回**” 。然而这个时间长短随着数据包途径的网络环境的不同而有所变化。例如在高速的 LAN 中时间相对较短,而在长距离的通信当中应该比 LAN 要长一些。

为了保持TCP的高性能通信，在每次发包时都会计算往返时间及其偏差，将这个往返时间和偏差相加重发超时的时间，就是比这个总和稍大一点的值。

**连接管理**

TCP提供**面向有连接**的通信传输，面向有连接是指在数据通信开始之前先做好通信两端之间的准备工作。TCP会在数据通信之前,通过 TCP 首部发送一个**SYN包**作为建立连接的请求等待确认应答。如果对端发来**确认应答**,则认为可以进行数据通信。如果对端的确认应答未能到达,就不会进行数据通信。此外,更多细节请参在通信结束时会进行断开连接的处理(FIN包)。

可以使用 TCP 首部用于控制的字段来管理 TCP 连接。一个连接的建立与断开,正常过程至少需要来回发送7个包才能完成。

**TCP以段为单位发送数据**

在建立TCP连接的同时，也可以确认发送数据包的单位，我们也可以称其为“**最大消息长度**”（MSS）。最理想的情况是，最大信息长度正好是IP中不会被分片处理的最大数据长度。

**利用窗口控制提高速度 (窗口传输知识点需要配合图解, 建议阅读原文或者查找一些资料)**

TCP 以1个段为单位,每发一个段进行一次确认应答的处理。这样的传输方式有一个缺点。那就是,包的往返时间越长通信性能就越低。

为了解决这个问题，TCP引入了**窗口**这个概念，即使往返较长的情况下，它也能控制网络性能的下降。如图所示,确认应答不再是以每个分段,而是以更大的单位进行确认时,转发时间将会被大幅度的缩短。也就是说,发送端主机,在发逸了一个段以后不必要一直等待确认应答,而是继续发送。

窗口大小就是指无需等待确认应答而可以继续发送数据的最大值.

**窗口控制与重发控制**

在使用窗口控制中，如果出现了段丢失该怎么办？

首先,我们先考虑**确认应答未能返回的情况**。在这种情况下,数据已经到达对端,是不需要再进行重发的。然而,在没有使用窗ロ控制的时候,没有收到确认应答的数据都会被重发。而使用了窗口控制,就如下图所示,某些确认应答即便丢失也无需重发。

其次，我们来考虑一下**某个报文段丢失**的情况，接受主机如果收到一个应该接收的序号以外的数据时，会针对当前为止收到数据返回取人应答。

**流控制**

接收端将本应该接收的数据丢弃的话,就又会触发重发机制,从而导致网络流量的无端浪费。为了防止这种现象的发生, TCP 提供一种机制可以让**发送端根据接收端的实际接收能力控制发送的数据量**。这就是所谓的流控制。

它的具体操作是,接收端主机向发送端主机通知自己可以接收数据的大小,于是发送端会发送不超过这个限度的数据。该大小限度就被称作窗口大小。

为了在发送端调节所要发送数据的量，定义了一个加做“拥塞窗口”的概念。 

**使用TCP的应用**

到此为止，我们了解到各种各样的控制机制。TCP采用这些机制可以提供高速，可靠的通信服务。

如果需要应用自己处理一些更为细节上的控制,使用 UDP 协议是不错的选择。如果转发数据量较多、对可靠性的要求比较高时,可以选择使用 TCP 。 TCP 和 UDP 两者各有长短,在设计和开发应用时,应准确掌握它们各自协议的特点酌情选择。

### 6.6 UDP 首部的格式

UDP首部由源端口号，目标端口号，包长和校验和组成。

- **源端口号**: 表示发送端端口号，字段长16位。该字段是可选项，有时可能不会设置端口号，没有根端口号的时候该字段的值设置位0，可用于**不需要返回的通信中**。
- **目标端口号**: 表示接收端端口，字段长度16位。
- **包长度**: 该字段保存了UDP首部的长度跟数据的长度之和，单位为字节（八位字节）。
- **校验和**: 校验和是为了提供可靠的UDP首部根数据而设计。

### 6.7 TCP 首部格式

TCP首部相比于UDP首部要复杂的多, 建议参考原文或者阅读相关资料

- **源端口号**: 表示发送端端口号，字段为16位。
- **目标端口号**: 表示接收端端口号，字段为16位。
- **序列号**: 字段长32位，序列号是指发送数据的位置，每发送一次数据，就累计一次该数据字节数的大小。
- **确认应答号**: 确认应答号字段长度32位，是指下一次应该收到的数据的序列号。
- **数据偏移**: 该字段表示TCP所传输的数据部分应该从TCP包的哪个位开始计算，当然也可以把它看成TCP数不对长度。
- **保留**: 该字段主要是为了以后拓展时，其长度为4位。一般设置为0，但即使收到的包在该字段不为0，此包也不会被丢弃。
- **控制位**: 字段长为 8 位，每一位从左到右分别为 CWR、ECE、URG、ACK、PSH、RST、SYN、Fin。

## 第七章 路由协议

### 7.1 路由控制的定义

**IP地址与路由控制**

互联网是由路由器连接的网络组合而成的。为了能让数据包正确达地到达目标主机,路由器必须在途中进行正确地转发。这种向“正确的方向”转发数据所进行的处理就叫做**路由控制**或**路由**。

**静态路由和动态路由**

那么,是谁又是怎样制作和管理路由控制表的呢?路由控制分静态＂和动态＂两种类型。

静态路由是指事先设置好路由器和主机中并将路由信息固定的一种方法。而动态路由是指让路由协议在运行过程中自动地设置路由控制信息的一种方法。这些方法都有它们各自的利弊。

不论是静态路由还是静态路由，不要只使用其中一种，可以将它们组合起来使用。

**动态路由的基础**

动态路由会给相邻路由器发送自己已知的网络连接信息,而这些信息又像接力一样依次传递给其他路由器,直至整个网络都了解时,路由控制表也就制作完成了。而此时也就可以正确转发IP 数据包了。

### 7.4 RIP

RIP是距离向量型的一种路由协议，广泛用于LAN。

**广播路由控制信息**

RIP将路由控制信息定期（30秒一次）向全网广播，如果没有收到路由控制信息,连接就会被断开。不过,这有可能是由于丢包导致的,因此 RIP 规定等待5次。如果等了6次(180秒)仍未收到路由信息,才会真正关闭连接。

**根据距离向量确定路由**

RIP 基于距离向量算法决定陪经。距离( Metnes )的单位为“跳数”。跳数是指所经过的路由器的个数。 RIP 希望尽可能少通过路由器将数据包转发到目标 IP 地址,如下图所示。根据距离向量生成距离向量表,再抽出较小的路由生收最终的路由控制表。

**RIP2**

RIP2是RIP第二版，与第一版工作机制基本相同，不过有如下几个新的特点。

- **使用多播**: RIP 中当路由器之间交换路由信息时采用广播的形式,然而在RIP2中改用了多播。这样不仅减少了网络的流量,还缩小了对无关主机的影响。
- **支持子网掩码**: 与 OSPF 类似的,RIP2支持在其交换的路由信息中加人子网掩码信息。
- **路由选择域**: 与OSPF的区域类似,在同一个网络中可以使用逻辑上独立的多个 RIP 。
- **外部路由标志**: 通常用于把从 BGP 等获得的路由控制信息通过 RIP 传递给 AS 内。
- **身份验证密钥**: 与OSPF一样,RIP包中掷带密码。只有在自己能够识别这个密码时才接收数据,否则忽略这个RIP包。

### 7.5 OSPF

OSPF ( Open Shortest Path First )是根据 OSI 的IS-IS协议而提出的一种链路状态型路由协议。由于采用链路状态类型,所以即使网络中有环路,也能够进行稳定的路由控制。

另外, OSPF 支持子网掩码。由此,曾经在 RIP 中无法实现的可变长度子网构造的网络路由控制成为现实。

甚至为了减少网络流量, OSPF 还引人了“区域”这一概念。区域是将一个自治网络划分为若干个更小的范围。由此,可以减少路由协议之间不必要的交换。

OSPF可以针对 IP 首部中的区分服务(T0s)字段,生成多个路由控制表。不过,也会出现已经实现了 OSPF 功能的路由器无法支持这个TOS的情况。

**OSPF是链路状态型路由协议**

OSPF为链路状态型路由器。路由器之间交换链路状态生成网络拓扑信息，然后再根据这个拓扑信息生成路由控制表。

RIP的路由选择，要求途中所经过的路由器个数越少越好。与之相比，OSPF可以给每条链路赋予一个权重，并选择一个权重最小的路径作为最终路由。

**OSPF基础知识**

OSPF中，把连接到同一个链路的路由器称作相邻路由器。简单的网络结构中，相邻路由器之间可以交换路由信息，但再复杂到达网络中，是确定一个制定路由器，并以它为中心交换路由信息即可。

在OSPF中，根据作用的不同可以分为5种类型的包。 

- 问候: 确认相邻路由器, 确定指定路由器
- 数据库描述: 链路状态数据库的摘要信息
- 链路状态请求: 请求从数据库中获取链路状态信息
- 链路状态更新: 更新链路状态数据库中的状态信息
- 链路状态确认应答: 链路状态信息更新的确认应答

**OSPF工作原理概述**

OSPF种进行连接确认端协议叫做HELLO协议。

LAN 中每10秒发送一个HELLO包。如果没有HELLO包到达,则进行连接是否断开的判断。具体为,允许空等3次,直到第4次(40秒后)仍无任何反应就认为连接已经断开。之后在进行连接断开或恢复连续操作时,由于链路状态发生了变化,路由器会发送一个链路状态更新包通知其他路由器网络状态的变化。

链路状态通知包所要传达的消息大致分为两类：一是网络链路状态通告，二是路由器链路状态通告。

**将区域分层化进行细分管理**

链路状态型路由协议的潜在问题在于，当网络规模越来越大时,表示链路状态的拓扑数据库就变得越来越大,路由控制信息的计算也就越困难。OSPF为了减少计算负荷,引人了**区域**的概念。

区域是指连接在一起的网络和主机划分为小组，使一个**自治系统 (AS)** 内可以拥有多个区域。不过具有多个区域的自治系统必须要有一个**主干区域**，并且所有其他区域必须都与这个主干系统相连接。

连接区域与主干区城的路由器称作**区域边界路由器**;而区域内部的路由器叫做内部路由器;只与主干区域内连接的路由器叫做主干路由器;与外部相连接的路由器就是 AS边界路由器。

每个区域内的路由器都持有本区域网络拓扑的数据库。至于区域之外的路径信息，只能从区域边界路由器那里获取他们的距离。 

只了解区域内部的链路状态信息，减轻了处理的负担。

此外, 作为区域出口的区域边界路由器若只有一个的话叫做**末端区域**。末端区域内不需要发送区域外的路由信息。它的区域边界路由器将成为默认路径传送路由信息即可。因此,由于不需要了解到达其他各个网络的距离,所以它可以减少一定地路由信息。

要想在OSPF中构造一个稳定的网络,物理设计和区域设计同样重要。如果区域设计不合理,就有可能无法充分发挥 OSPF 的优势。

### 7.6 BGP

边界网关协议是连接不同组织机构的一种协议。

边界网关协议是连接不同组织机构的一种协议。

**BGP与AS号**

在RIP和OSPF中利用IP的网络地址进行着路由控制，然而BGP则需要**放眼整个互联网互联网进行路由控制**，BGP的最终路由控制表由**网络地址**和**下一战的路由器组**来表示，不过它会根据所要经过的AS个数进行路由控制。

ISP,区域网络等会将每个网络编制成一个个**自治系统**进行控制。它们为每个自治系统分配一个16比特的AS编号，BGP就是根据这个编号进行相应的路由控制。

**BGP是路径向量协议**

根据 BCP 交换路由控制信息的路由器叫做 BCP 扬声器。 BCP 扬声器为了在 AS 之间交换 BCP 信息,必须与所有 AS 建立对等的 BCP 连接。

## 第八章 应用协议

### 8.1 应用层协议概要

之前介绍的主要是指OSI参考模型的下半部分，从本章开始介绍OSI上半部分。(应用层/表示层/会话层)

**应用协议的定义**

利用网络的应用程序有很多,包括 Web 浏览器、电子邮件、远程登录、文件传输、网络管理等。能够让这些应用进行特定通信处理的正是应用协议。 

TCP 和 IP 等下层协议是不依赖于上层应用类型、适用性非常广的协议。而应用协议则是为了实现某种应用而设计和创造的协议。

**应用协议与协议的分层**

网络应用由不同的用户和软件供应商开发而成。为了实现网络应用的功能,在应用之间进行通信时将其连接的网络协议是非常重要的”。设计师和开发人员根据所开发模块的功能和目的,可以利用现有的应用协议,也可以自己定义一个新的应用协议。

应用可以直接享用传输层以下的基础部分。因为开发者只要关心选用哪种应用协议、如何开发即可,而不必担心应用中的数据该以何种方式发送到目标主机等问题。这也是得益于网络层的功劳。

相当于OSI中第5，第6，第7层的协议

### 8.2 远程登录

远程登陆是为了实现TSS（**分时系统**：分时是指多个用户分享使用同一台计算机）环境，将终端和主机相连。

从自己的本机计算机登录到网络另一端的应用就叫远程登陆。

**TELNET**

TELNET 利用 **TCP** 的一条连接,通过这一条连接向主机发送文字命令并在主机上执行。本地用户好像直接与远端主机内部的 Shell 相连着似的,直接在本地进行操作。

TELNET 可以分为两类基本服务。一是仿真终端功能,二是协商选项机制。

通过TELNET登陆主机或路由器等设备时需要将自己的登陆用户名和密码注册到服务端。

TELNET中除了处理用户所输入的文字外，还提供选项的交互和协商功能。

- 行模式: 每从键盘输入一个换行，就将该行的数据作为1整行发送给服务端B
- 透明模式: 客户端A每输人一个字符都要发送给服务端B

**SSH**

SSH是加密的远程登陆系统。SSH还包括很多非常方便的功能。

- 可以使用更强的认证机制。
- 可以转发文件。
- 可以使用端口转发功能。

端口转发是指将特定端口号所收到的消息转发到特定的 IP 地址和端口号码的一种机制。由于经过 SSH 连接的那部分内容被加密,确保了信息安全,提供了更为灵活的通信。

### 8.3 文件传输

FTP是在两个相连的计算机之间进行文件传输时使用的协议。FTP中也需要在登录到对方对方的计算机后才能进行相应的操作。

**FTP的工作机制概要**

FTP使用两条TCP连接：一条用来控制，另一条用于数据的传输。以此实现文件传输功能

### 8.4 电子邮件

电子邮件顾名思义就是网络上的邮政。

**电子邮件的工作机制**

提供电子邮件的协议加做SMTP。SMTP为了实现高效发送邮件内容，在传输层使用了TCP协议。

为了避免对方因未插电而无法接收邮件，引进了一种一直会连接电源的邮件服务器。

**邮件地址**

使用电子邮件时需要拥有的地址叫做邮件地址。互联网中电子邮件地址的格式如: 名称@通信地址

**MIME**

很长一段时间里，电子邮件只能处理文本格式的邮件，有了MIME就可以发送动态图像，动画，声音，程序等各种各样的数据。

**SMTP**

SMTP是发送电子邮件的协议，它使用的是TCP的25号端口。客户端以文本的形式发出请求，服务端返回一个3位数字的应答。

**IMAP**

IMAP 与 POP 类似,也是接收电子邮件的协议。在 POP 中邮件由客户端进行管理,而在 IMAP 中邮件则由服务器进行管理。 

有了 IMAP 人们就可以通过个人电脑、公司的电脑、笔记本电脑以及智能手机等连接到 IMAP 服务器以后进行收发邮件。由此,在公司下载的电子邮件就不必在笔记本电脑和智能手机上转来转去。 IMAP 确实为使用多种异构终端的人们提供了非常便利的环境。

### 8.5 WWW

万维网（www）是将互联网中的信息以**超文本形式**呈现的系统。可以显示WWW信息的客户端软件叫做**Web浏览器**。借助浏览器，人们不需要考虑该信息保存在哪个服务器，只需要轻轻点击鼠标就可以访问页面上的链接并打开相关信息。

很多公司的主页形式如：`http://www.公司名称.co.jp/`

**www基本概念**

www 定义了3个重要的概念,它们分别是访问信息的手段与位置( URI )、信息的表现形式( HTML )以及信息转发( HTTP )等操作。

**URI**

用于**标识资源**，是一种可以用于WWW之外的高效的识别码，它被用于主页地址，电子邮件，电话号码等各种组合中。URL属于一般主页地址。

**HTML**

HTMP 是记述 Web 页的一种语言(数据格式)。它可以指定浏览器中显示的文字、文字的大小和颜色。此外,不仅可以对图像或动画进行相关设置,还可以设置音频内容。

HTML 具有**纯文本**的功能。在页面中不仅可以为文字或图像附加链接,当用户点击那些链接时还可以呈现该链接所指示的内容,因此它可以将整个互联网中任何一个 WWW 服务器中的信息以链接的方式展现。绝大多数互联网中的 Web 页,都以链接的形式指向关联的其他信息。

逐一点开这些链接就可以了解全世界的信息。 HTML 也可以说是 www 通用的数据表现协议。

**HTTP**

当用户在浏览器的地址栏里输人所要访问 Web 页的 URI 以后, HTTP 的处理即会开始。 HTTP 中默认使用80端口。它的工作机制,首先是客户端向服务器的80端口建立一个 TCP 连接,然后在这个 TCP 连接上进行请求和应答以及数据报文的发送。

HTTP常用的有两个版本，一个是HTTP1.0，另一个是HTTP1.1，从1.1开始允许在一个TCP连接上发送多个命令和应答。

### 8.6 网络管理

**SNMP**

以前，网络管理都是凭借管理员的记忆和直觉进行。而随着网络规模的扩大，需要一个严密的管理工具或方法显得格外重要。TCP/IP使用SNMP收集必要的协议。

SNMP中管理端叫做**管理器**，被管理端叫做代理。

SNMPv3中将“消息处理”、“用户安全”和“访问控制”三部分分开考虑,可以为每一个部选择各自必要的机制。

消息处理中如果选择了SNMPv2的模型,那么会进行以下8种操作。它们分别是:查询请求,上次要求的下一个信息的查询请求(GetNexiRequest-PDU)、应答、设置请求、批量查询请求(CetBulkRequest-PDU)、向其他管理器发送信息通知(InformRequest-PDU)、事件通知、用管理系统定义的命令(Report-PDU)等操作。

**MIB**

SNMP 中交互的信息是 MIB ( Management Information Base )。 MIB 是在树形结构的数据库中为每个项目附加编号的一种信息结构。

MIB 相当于 SNMP 的表示层,它是一种能够在网络上传输的结构。 SNMP 中可以将 MIB 值写人代理,也可以从代理中读取 MIB 值。通过这些操作可以收集冲突的次数和流量统计等信息,可以修改接口的 IP 地址,还可以进行路由器的启停、设备的启动和关闭等处理。

**RMON**

RMON 是 Remote Monitoring MIB 的缩写。 MIB 由监控网络中某个设备接口(某个点)的众多参数构成。相比之下, RMON 则由监控网络上线路的众多参数构成。 

RMON 中可监控的信息从原来的一个点扩展到了一条线上。这样可以更高效率地监控网络。可监控的内容上也增加了很多从用户角度看极为有意义的信息,如网络流量统计等。

## 第九章 网络安全

### 9.1 TCP/IP 与网络安全

随着互联网的普及，发生了很多非法访问，恶意攻击等问题，影响了企业和个人的利益。由此，网络安全逐渐成为人们不可忽视的一个重要内容。

“便利性”和“安全性”作为两个对立的特性进行兼容。为了安全，需要牺牲部分便利。

### 9.2 网络安全构成要素

网络安全最基本要领是要有预备方案。强调事前制定对策，而不是事后处理。

在此，我们针对每一个要素进行介绍。

**防火墙**

组织机构内部的网络和互联网相连时，为了避免域内收到非法访问的威胁，往往会设置防火墙。数据包符合安全策略，防火墙才会让其通过。

下图中是一个设置防火墙的例子，对路由器设置了只向其发送特定地址和端口号的包。

**IDS（入侵检测系统）**

数据包符合安全策略，防火墙才会让其通过。但只要与策略相符，就无法判断当前访问是否非法访问，所以全部允许通过。

而IDS正是检查这种已经侵入内部网络进行非法访问的情况，并及时通知给网络管理员的系统。

**反病毒/个人防火墙**

反病毒和个人防火墙是继IDS和防火墙之后的另外两种安全对策，它们往往是用户使用的计算机或服务器上运行的软件。

既可以监控计算机中进出的所有包，数据和文件，也可以防止对计算机的异常操作和病毒入侵。

### 9.3 加密技术基础

一般情况下,网页访问、电子邮件等互联网上流动的数据不会被加密。另外,互联网中这些数据经由哪些路径传输也不是使用者可以预知的内容。因此,通常无法避免这些信息会泄露给第三方。

为了防止这种信息的泄露、实现机密数据的传输,出现了各种各样的加密技术。加密技术分布与 OSI 参考模型的各个阶层一样,相互协同保证通信。

**对称密码体制与公钥密码体制**

加密是指利用某个值 (密钥) 对明文的数据通过一定的算法变换成加密 (密文) 数据的过程。它的逆反过程叫做解密。

**加密和解密使用相同的密钥**叫做**对称加密方式**。反之，如果在**加密和解密过程中分别使用不同的密钥**则叫做**公钥加密方式**。 

**身份认证技术**

在实施安全对策时，有必要验证使用者的**正确性**和**真实性**。如果不是正当的使用者要拒绝其访问，为此，需要数据加密的同时还要有认证技术。

认证可以分为如下几类

1. 根据所知道的信息进行认证
指使用密码或私有代码(私有识别玛)的方式。为了不让密码丢失或不被轻易推测出来,用户自己需要多加防范。使用公钥加密方式进行的数字认还,就需要验证是否持有私钥。

2. 根据所拥有的信息进行验证
据所拥有的信息进行认证指利用 ID 卡、密钥、电子证书、电话号码等信息的方式。在移动手机互联网中就是利用手机号码成终端信息进行权限认证。

3. 根据独一无二的体态特征进行认证
指根据指纹、视网膜等个人特有的生物特征进行认证的方式。

从认证级别和成本效益的角度考虑,一般会综合上述3种方式的情况更为普遍。另外,还有一种**集合各种终端、服务器和应用的认证**于一起进行综合管理的技术叫做 **IDM** ( IDentity Managrment )。

### 9.4 安全协议

**IPsec与VPN**

以前,为了防止信息泄焦,对机密数据的传输一般不使用互联网等公共网络( Publie Nctvork ),而是使用由专线连接的**私有网络**( Paivate Network )。从而在物理上杜绝了窃听和篡改数据的可能。然而,专线的造价太高是一个不可回避的问题。

为了解决此类问题,人们想出了在互联网上构造一个虚拟的私有网络VPN ( Virtual Private Network ,虚拟专用网)。互联网中采用加密和认证技术可以达到“**即使读取到数据也无法读懂**”、“**检查是否被篡改**”等功效。 VPN 正是一种利用这两种技术打造的网络。

在构建 VPN 时,最常被使用的是 **IPsec** 。它是指在 IP 首部的后面追加“**封装安全有效载荷**”和“**认证首部**”,从而对此后的数据进行加密,不被盗取者轻易解读。

**TLS/SSL与HTTPS**

现在有很多互联网应用已经逐渐进人人们的生活。例如网上购物、网上订车票、订飞机票或预订演出票等。在这些系统的支付过程中经常会涉及信用卡网上支付,而网上银行系统还備要用户直接在网上输人账号和密码。

而信用卡卡号、银行账号、密码都属于个人的机密信息。因此,在网络上传输这些信息时有必要对它们进行加密处理。 **Web 中可以通过 TLS/SSL 对 HTTP 通信进行加密。使用 TLS / SSL 的 HTTP 通信叫做 HTTPS 通信。 HTTPS 中采用对称加密方式。而在发送其公共密钥时采用的则是公钥加密方式。**

确认公钥是否正确主要使用认证中心签发的证书，而主要的认证中心的信息已经嵌入到游览器的出厂设置中。如果 Web 浏览器中尚未加入某个证书中心, 那么实在页面上提示一个警告信息. 此时, 判断认证中心合法是否与否就交由用户自己决定

**IEEE802.1X**

IEEE802. 1X 是为了能够接入 LAN 交换机和无线 LAN 接人点而对用户进行认证的技术。并且它只允许被认可的设备才能访问网络。虽然它是一个提供数据镂路层控制的规范,但是与 TCP / IP 关系紧密。一般,由客户端终端、 AP (无线基站)或2层交换机以及认证服务器组成。